#!/usr/bin/env node

/**
 * Script final para corrigir os √∫ltimos problemas
 */

const fs = require('fs');
const path = require('path');

console.log('üîß Aplicando corre√ß√£o final dos √∫ltimos problemas...\n');

// Fun√ß√£o para ler arquivo
function readFile(filePath) {
  try {
    return fs.readFileSync(filePath, 'utf8');
  } catch (error) {
    console.error(`‚ùå Erro ao ler arquivo ${filePath}:`, error.message);
    return null;
  }
}

// Fun√ß√£o para escrever arquivo
function writeFile(filePath, content) {
  try {
    fs.writeFileSync(filePath, content, 'utf8');
    console.log(`‚úÖ Arquivo corrigido: ${filePath}`);
    return true;
  } catch (error) {
    console.error(`‚ùå Erro ao escrever arquivo ${filePath}:`, error.message);
    return false;
  }
}

// CORRE√á√ÉO 1: next.config.js - Remover configura√ß√£o inv√°lida
function fixNextConfig() {
  console.log('\nüîß Corrigindo configura√ß√£o inv√°lida em next.config.js...');
  
  const filePath = './next.config.js';
  const content = readFile(filePath);
  
  if (!content) return false;
  
  // Remover configura√ß√£o inv√°lida de ESLint
  const fixedContent = content.replace(
    /\/\/ Configura√ß√£o de ESLint mais permissiva[\s\S]*?nextConfig\.eslint = eslintConfig;[\s\S]*?module\.exports = nextConfig/,
    'module.exports = nextConfig'
  );
  
  return writeFile(filePath, fixedContent);
}

// CORRE√á√ÉO 2: processes/route.ts - Corrigir erro de tipo com process.env
function fixProcessesRouteEnvError() {
  console.log('\nüîß Corrigindo erro de tipo com process.env em processes/route.ts...');
  
  const filePath = './app/api/illustrations/processes/route.ts';
  const content = readFile(filePath);
  
  if (!content) return false;
  
  // Corrigir o erro de tipo com process.env
  const fixedContent = content.replace(
    /`\${process\.env\.NEXT_PUBLIC_BASE_URL \|\| 'http:\/\/localhost:3000'}\/api\/illustrations\/search`/g,
    '`${process.env.NEXT_PUBLIC_BASE_URL || \'http://localhost:3000\'}/api/illustrations/search`'
  );
  
  return writeFile(filePath, fixedContent);
}

// CORRE√á√ÉO 3: IllustrationSearch.tsx - Encontrar e corrigir o img espec√≠fico na linha 343
function fixIllustrationSearchImgFinal() {
  console.log('\nüîß Corrigindo img espec√≠fico em IllustrationSearch.tsx...');
  
  const filePath = './components/illustrations/IllustrationSearch.tsx';
  const content = readFile(filePath);
  
  if (!content) return false;
  
  let fixedContent = content;
  
  // Verificar se j√° tem import do Image
  if (!content.includes("import Image from 'next/image'")) {
    // Adicionar import do Image
    fixedContent = content.replace(
      /import React, { useState, useEffect, useCallback } from ['"]react['"];?\s*/,
      "import React, { useState, useEffect, useCallback } from 'react';\nimport Image from 'next/image';\n"
    );
  }
  
  // Encontrar e substituir o img espec√≠fico na linha 343
  const lines = fixedContent.split('\n');
  if (lines[342]) { // linha 343 (√≠ndice 342)
    const originalLine = lines[342];
    console.log(`Linha original: ${originalLine}`);
    
    // Substituir img por Image
    lines[342] = originalLine.replace(
      /<img[^>]*\/>/g,
      (match) => {
        // Extrair src e alt se existirem
        const srcMatch = match.match(/src="([^"]*)"/);
        const altMatch = match.match(/alt="([^"]*)"/);
        const classNameMatch = match.match(/className="([^"]*)"/);
        
        const src = srcMatch ? srcMatch[1] : '';
        const alt = altMatch ? altMatch[1] : '';
        const className = classNameMatch ? classNameMatch[1] : '';
        
        return `<Image src="${src}" alt="${alt}" width={400} height={192} className="${className}" />`;
      }
    );
    
    console.log(`Linha corrigida: ${lines[342]}`);
  }
  
  fixedContent = lines.join('\n');
  
  return writeFile(filePath, fixedContent);
}

// Fun√ß√£o principal
async function main() {
  console.log('üöÄ Aplicando corre√ß√£o final dos √∫ltimos problemas...\n');
  
  let successCount = 0;
  let totalFixes = 3;
  
  // Executar todas as corre√ß√µes
  const fixes = [
    { name: 'Configura√ß√£o inv√°lida next.config.js', fn: fixNextConfig },
    { name: 'Erro de tipo processes/route.ts', fn: fixProcessesRouteEnvError },
    { name: 'Img espec√≠fico IllustrationSearch', fn: fixIllustrationSearchImgFinal }
  ];
  
  for (const fix of fixes) {
    console.log(`\nüìù Aplicando corre√ß√£o: ${fix.name}`);
    if (fix.fn()) {
      successCount++;
      console.log(`‚úÖ ${fix.name} - Corrigido com sucesso!`);
    } else {
      console.log(`‚ùå ${fix.name} - Falha na corre√ß√£o!`);
    }
  }
  
  console.log('\n' + '='.repeat(50));
  console.log(`üìä RESUMO DA CORRE√á√ÉO FINAL:`);
  console.log(`‚úÖ Sucessos: ${successCount}/${totalFixes}`);
  console.log(`‚ùå Falhas: ${totalFixes - successCount}/${totalFixes}`);
  
  if (successCount === totalFixes) {
    console.log('\nüéâ Todas as corre√ß√µes finais foram aplicadas!');
    console.log('\nüìã Execute: npm run build');
  } else {
    console.log('\n‚ö†Ô∏è  Algumas corre√ß√µes falharam. Verifique os logs acima.');
  }
}

// Executar script
if (require.main === module) {
  main().catch(console.error);
}

module.exports = {
  fixNextConfig,
  fixProcessesRouteEnvError,
  fixIllustrationSearchImgFinal
};
