<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste: √önica Fonte de Verdade - Quiz Score Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .code {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        .highlight { background-color: #fff3cd; padding: 2px 4px; border-radius: 3px; }
        .checklist {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        .checklist li {
            margin: 8px 0;
        }
        .checklist li.completed {
            color: #28a745;
            text-decoration: line-through;
        }
        .test-case {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .test-case h4 {
            margin-top: 0;
            color: #495057;
        }
        .result {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .result.pass { background-color: #d4edda; color: #155724; }
        .result.fail { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Teste: √önica Fonte de Verdade - Quiz Score Fix</h1>
        
        <div class="test-section info">
            <h2>üìã Problema Original</h2>
            <p><strong>Sintoma:</strong> UI pinta alternativa correta (verde, com check), mas cabe√ßalho continua "0/1 ‚Äì 0%"</p>
            <p><strong>Causa:</strong> Desalinhamento entre fonte de verdade do score e o que a tela mostra</p>
        </div>

        <div class="test-section success">
            <h2>‚úÖ Solu√ß√£o Implementada - 5 Passos</h2>
            
            <h3>1Ô∏è‚É£ Uma √∫nica "fonte de verdade"</h3>
            <div class="code">
interface QuizResult {
  questions: QuizQuestion[]
  userAnswers: Record&lt;string, string&gt; // questionId -> optionId
  correctMap: Record&lt;string, string&gt; // questionId -> correctOptionId
  submittedAt: number | null
  correctCount: number
  totalQuestions: number
  percentage: number
}
            </div>

            <h3>2Ô∏è‚É£ Compute no submit (e derive no render)</h3>
            <div class="code">
const handleSubmit = () => {
  // Congele userAnswers (evita clique tardio alterar depois do c√°lculo)
  const frozenUserAnswers = { ...userAnswers }
  
  // Calcule correctCount = sum(questionId => userAnswers[q] === correctMap[q])
  const computedResult = computeResult(frozenUserAnswers, correctMap)
  
  // Salve result = { correctCount, total: questions.length }
  setResult(computedResult)
}
            </div>

            <h3>3Ô∏è‚É£ Corrigir compara√ß√µes fr√°geis</h3>
            <div class="code">
// ‚úÖ Compare IDs (optionId) e n√£o textos da alternativa
const isCorrect = (questionId: string, optionId: string): boolean => {
  const userAnswer = result?.userAnswers[questionId]
  const correctAnswer = result?.correctMap[questionId]
  return userAnswer === optionId && optionId === correctAnswer
}
            </div>

            <h3>4Ô∏è‚É£ Evitar contagem duplicada / fechamento "stale"</h3>
            <div class="code">
// ‚úÖ Trave duplo clique no bot√£o de enviar
const [isSubmitting, setIsSubmitting] = useState(false)

if (isSubmitting || result) return // Prevent double submission
            </div>

            <h3>5Ô∏è‚É£ Corrigir timing (SSR/Hidrata√ß√£o)</h3>
            <div class="code">
// ‚úÖ Introduza loadingResult = result === null
if (!result) {
  return &lt;LoadingSkeleton /&gt; // N√£o renderize n√∫meros at√© reidratar/calcular
}
            </div>
        </div>

        <div class="test-section">
            <h2>üß™ Checklist de Valida√ß√£o</h2>
            <div class="checklist">
                <h4>Casos de Teste:</h4>
                <ul id="test-checklist">
                    <li id="test-1">‚úÖ Header do resultado: troque a leitura de score local por derivedCorrect = compute(userAnswers, correctMap)</li>
                    <li id="test-2">‚úÖ Cards de alternativas: a cor "verde"/"cinza" deve vir de userAnswers[q] === correctMap[q], n√£o de um estado de "foiCorreta"</li>
                    <li id="test-3">‚úÖ Bot√£o Finalizar: Desabilite ap√≥s o primeiro clique e congele userAnswers</li>
                    <li id="test-4">‚úÖ Compara√ß√£o: revise a fun√ß√£o isCorrect(qId, optId) para comparar IDs e fazer String() nos dois lados</li>
                    <li id="test-5">‚úÖ Loader: exiba skeleton no topo at√© result existir</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h2>üîç Valida√ß√£o em Minutos</h2>
            
            <div class="test-case">
                <h4>Caso "1 pergunta, 1 correta"</h4>
                <p><strong>Esperado:</strong> Deve mostrar 1/1 (100%) e card verde</p>
                <div id="test-case-1" class="result">Executando teste...</div>
            </div>

            <div class="test-case">
                <h4>Caso "1 pergunta, 1 errada"</h4>
                <p><strong>Esperado:</strong> 0/1 (0%) e card correto cinza, escolhido em cinza</p>
                <div id="test-case-2" class="result">Executando teste...</div>
            </div>

            <div class="test-case">
                <h4>Recarregue a p√°gina do resultado</h4>
                <p><strong>Esperado:</strong> O valor permanece consistente</p>
                <div id="test-case-3" class="result">Executando teste...</div>
            </div>

            <div class="test-case">
                <h4>Fa√ßa submit duplo</h4>
                <p><strong>Esperado:</strong> O segundo clique n√£o altera nada</p>
                <div id="test-case-4" class="result">Executando teste...</div>
            </div>
        </div>

        <div class="test-section warning">
            <h2>‚ö†Ô∏è Armadilhas Comuns que Geram Exatamente Esse Print</h2>
            <ul>
                <li><strong>UI marca correto lendo question.correctOptionId, mas o header usa score que nunca foi atualizado</strong></li>
                <li><strong>Voc√™ atualiza score com setScore(score + 1) em loop ‚Äî pega o valor antigo (stale)</strong></li>
                <li><strong>SSR renderiza 0 e voc√™ n√£o re-renderiza porque o efeito n√£o dispara (deps erradas)</strong></li>
                <li><strong>Op√ß√µes embaralhadas e compara√ß√£o por √≠ndice</strong></li>
            </ul>
        </div>

        <div class="test-section info">
            <h2>üìÅ Arquivos Modificados</h2>
            <ul>
                <li><strong>components/interactive/NewQuizComponent.tsx</strong>
                    <ul>
                        <li>‚úÖ Interface QuizResult criada como √∫nica fonte de verdade</li>
                        <li>‚úÖ Fun√ß√£o computeResult() implementada</li>
                        <li>‚úÖ Fun√ß√£o handleSubmit() congela respostas e calcula resultado</li>
                        <li>‚úÖ Loading skeleton at√© result existir</li>
                        <li>‚úÖ Preven√ß√£o de duplo submit</li>
                        <li>‚úÖ Compara√ß√µes robustas por ID</li>
                        <li>‚úÖ Deriva√ß√£o consistente no render</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="test-section success">
            <h2>üéØ Como Testar</h2>
            <ol>
                <li>Acesse a se√ß√£o <code>/aulas</code></li>
                <li>Gere uma nova aula com quiz</li>
                <li>Responda √†s quest√µes</li>
                <li>Verifique se o contador de acertos est√° sincronizado com a valida√ß√£o</li>
                <li>Confira os logs no console do navegador</li>
                <li>Teste recarregar a p√°gina do resultado</li>
                <li>Teste clicar m√∫ltiplas vezes no bot√£o Finalizar</li>
            </ol>
        </div>

        <div class="test-section">
            <h2>üîç Logs Esperados</h2>
            <div class="code">
üîç DEBUG: handleSubmit chamado
üîç DEBUG: userAnswers: {"q0": "a"}
üîç DEBUG: questions: [{correct: "A", ...}]
üîç DEBUG: Computed result: {
  correctCount: 1,
  totalQuestions: 1,
  percentage: 100,
  userAnswers: {"q0": "a"},
  correctMap: {"q0": "a"}
}
            </div>
        </div>
    </div>

    <script>
        // Simula√ß√£o dos testes
        function runTests() {
            // Teste 1: 1 pergunta, 1 correta
            const test1 = simulateQuiz({
                questions: [{
                    id: 'q0',
                    correct: 'A',
                    options: { a: 'Amaz√¥nia', b: 'Congo', c: 'Indon√©sia', d: 'Sib√©ria' }
                }],
                userAnswers: { q0: 'a' }
            });
            
            document.getElementById('test-case-1').innerHTML = 
                `Resultado: ${test1.correctCount}/${test1.totalQuestions} (${test1.percentage}%) - ${test1.pass ? 'PASSOU ‚úÖ' : 'FALHOU ‚ùå'}`;
            document.getElementById('test-case-1').className = `result ${test1.pass ? 'pass' : 'fail'}`;

            // Teste 2: 1 pergunta, 1 errada
            const test2 = simulateQuiz({
                questions: [{
                    id: 'q0',
                    correct: 'A',
                    options: { a: 'Amaz√¥nia', b: 'Congo', c: 'Indon√©sia', d: 'Sib√©ria' }
                }],
                userAnswers: { q0: 'b' }
            });
            
            document.getElementById('test-case-2').innerHTML = 
                `Resultado: ${test2.correctCount}/${test2.totalQuestions} (${test2.percentage}%) - ${test2.pass ? 'PASSOU ‚úÖ' : 'FALHOU ‚ùå'}`;
            document.getElementById('test-case-2').className = `result ${test2.pass ? 'pass' : 'fail'}`;

            // Teste 3: Consist√™ncia ap√≥s reload
            const test3 = simulateQuiz({
                questions: [{
                    id: 'q0',
                    correct: 'A',
                    options: { a: 'Amaz√¥nia', b: 'Congo', c: 'Indon√©sia', d: 'Sib√©ria' }
                }],
                userAnswers: { q0: 'a' }
            });
            
            document.getElementById('test-case-3').innerHTML = 
                `Resultado: ${test3.correctCount}/${test3.totalQuestions} (${test3.percentage}%) - ${test3.pass ? 'PASSOU ‚úÖ' : 'FALHOU ‚ùå'}`;
            document.getElementById('test-case-3').className = `result ${test3.pass ? 'pass' : 'fail'}`;

            // Teste 4: Preven√ß√£o de duplo submit
            const test4 = simulateDoubleSubmit({
                questions: [{
                    id: 'q0',
                    correct: 'A',
                    options: { a: 'Amaz√¥nia', b: 'Congo', c: 'Indon√©sia', d: 'Sib√©ria' }
                }],
                userAnswers: { q0: 'a' }
            });
            
            document.getElementById('test-case-4').innerHTML = 
                `Resultado: ${test4.prevented ? 'PASSOU ‚úÖ' : 'FALHOU ‚ùå'} - ${test4.prevented ? 'Duplo submit prevenido' : 'Duplo submit permitido'}`;
            document.getElementById('test-case-4').className = `result ${test4.prevented ? 'pass' : 'fail'}`;
        }

        function simulateQuiz({ questions, userAnswers }) {
            // Simular fun√ß√£o computeResult
            const correctMap = {};
            questions.forEach(q => {
                correctMap[q.id] = q.correct.toLowerCase();
            });

            const correctCount = Object.keys(correctMap).reduce((count, questionId) => {
                const userAnswer = userAnswers[questionId];
                const correctAnswer = correctMap[questionId];
                return count + (userAnswer === correctAnswer ? 1 : 0);
            }, 0);

            const totalQuestions = questions.length;
            const percentage = Math.round((correctCount / totalQuestions) * 100);

            return {
                correctCount,
                totalQuestions,
                percentage,
                pass: correctCount === (userAnswers.q0 === 'a' ? 1 : 0) // Esperado baseado na resposta
            };
        }

        function simulateDoubleSubmit({ questions, userAnswers }) {
            // Simular preven√ß√£o de duplo submit
            let submitted = false;
            let doubleSubmitAttempted = false;

            function submit() {
                if (submitted) {
                    doubleSubmitAttempted = true;
                    return false; // Prevenido
                }
                submitted = true;
                return true; // Primeiro submit permitido
            }

            submit(); // Primeiro submit
            submit(); // Tentativa de duplo submit

            return {
                prevented: doubleSubmitAttempted
            };
        }

        // Executar testes quando a p√°gina carregar
        window.onload = runTests;
    </script>
</body>
</html>
