<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Gemini Native Audio</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .audio-player { border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .button { background: #8b5cf6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #7c3aed; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .status { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px; }
        .error { background: #fee; color: #c00; }
        .success { background: #efe; color: #060; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Teste Gemini Native Audio</h1>
        
        <div class="audio-player">
            <h3>Gemini 2.5 Flash Native Audio</h3>
            <p>Voz: Zephyr - Voz neutra e equilibrada</p>
            
            <div id="status" class="status">Pronto para gerar √°udio</div>
            
            <button id="generateBtn" class="button">
                üîä Gerar √Åudio
            </button>
            
            <div id="controls" style="display: none; margin-top: 10px;">
                <button id="playBtn" class="button">‚ñ∂Ô∏è Reproduzir</button>
                <button id="pauseBtn" class="button">‚è∏Ô∏è Pausar</button>
            </div>
        </div>
        
        <audio id="audioElement" style="display: none;"></audio>
    </div>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const status = document.getElementById('status');
        const controls = document.getElementById('controls');
        const audioElement = document.getElementById('audioElement');
        
        let audioUrl = null;
        let isPlaying = false;
        
        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function showControls() {
            controls.style.display = 'block';
        }
        
        async function generateAudio() {
            try {
                generateBtn.disabled = true;
                updateStatus('üîÑ Gerando √°udio...', 'info');
                
                const response = await fetch('/api/tts/gemini-native', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: 'Ol√°, este √© um teste de √°udio com Gemini 2.5 Native Audio.',
                        voice: 'Zephyr'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                updateStatus('üì° Recebendo stream...', 'info');
                
                const reader = response.body?.getReader();
                if (!reader) {
                    throw new Error('No response body reader available');
                }
                
                const audioChunks = [];
                let chunkCount = 0;
                let detectedMimeType = 'audio/mpeg';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = new TextDecoder().decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.type === 'audio' && data.data) {
                                    chunkCount++;
                                    console.log(`üéµ Chunk ${chunkCount} recebido: ${data.data.length} chars`);
                                    
                                    if (chunkCount === 1 && data.mimeType) {
                                        detectedMimeType = data.mimeType;
                                        console.log(`üéµ MIME type detectado: ${detectedMimeType}`);
                                    }
                                    
                                    // Convert base64 to Uint8Array
                                    const binaryString = atob(data.data);
                                    const audioData = new Uint8Array(binaryString.length);
                                    for (let i = 0; i < binaryString.length; i++) {
                                        audioData[i] = binaryString.charCodeAt(i);
                                    }
                                    audioChunks.push(audioData);
                                    
                                } else if (data.type === 'done') {
                                    console.log('‚úÖ Stream completo');
                                    break;
                                } else if (data.type === 'error') {
                                    throw new Error(data.content || 'Streaming error');
                                }
                            } catch (e) {
                                console.warn('Erro ao parsear SSE:', e);
                            }
                        }
                    }
                }
                
                if (audioChunks.length === 0) {
                    throw new Error('Nenhum chunk de √°udio recebido');
                }
                
                updateStatus(`üîó Combinando ${audioChunks.length} chunks...`, 'info');
                
                // Combinar chunks
                const totalLength = audioChunks.reduce((sum, chunk) => sum + chunk.length, 0);
                const combinedAudio = new Uint8Array(totalLength);
                let offset = 0;
                
                for (const chunk of audioChunks) {
                    combinedAudio.set(chunk, offset);
                    offset += chunk.length;
                }
                
                // Criar blob e URL
                const audioBlob = new Blob([combinedAudio], { type: detectedMimeType });
                audioUrl = URL.createObjectURL(audioBlob);
                
                console.log(`üéµ √Åudio criado: ${audioBlob.size} bytes, tipo: ${detectedMimeType}`);
                
                // Configurar elemento de √°udio
                audioElement.src = audioUrl;
                audioElement.load();
                
                updateStatus(`‚úÖ √Åudio gerado com sucesso! (${audioBlob.size} bytes)`, 'success');
                showControls();
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                updateStatus(`‚ùå Erro: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
            }
        }
        
        function playAudio() {
            if (audioUrl && audioElement) {
                audioElement.play().then(() => {
                    isPlaying = true;
                    playBtn.style.display = 'none';
                    pauseBtn.style.display = 'inline-block';
                    updateStatus('‚ñ∂Ô∏è Reproduzindo...', 'success');
                }).catch(error => {
                    console.error('Erro ao reproduzir:', error);
                    updateStatus(`‚ùå Erro ao reproduzir: ${error.message}`, 'error');
                });
            }
        }
        
        function pauseAudio() {
            if (audioElement) {
                audioElement.pause();
                isPlaying = false;
                playBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
                updateStatus('‚è∏Ô∏è Pausado', 'info');
            }
        }
        
        // Event listeners
        generateBtn.addEventListener('click', generateAudio);
        playBtn.addEventListener('click', playAudio);
        pauseBtn.addEventListener('click', pauseAudio);
        
        // Audio events
        audioElement.addEventListener('ended', () => {
            isPlaying = false;
            playBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            updateStatus('‚úÖ √Åudio finalizado', 'success');
        });
        
        audioElement.addEventListener('error', (e) => {
            console.error('Erro no √°udio:', e);
            updateStatus('‚ùå Erro no √°udio', 'error');
        });
        
        console.log('üé§ Teste Gemini Native Audio carregado');
    </script>
</body>
</html>
