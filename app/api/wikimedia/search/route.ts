// app/api/wikimedia/search/route.ts
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { query, subject, count = 1 } = body;

    if (!query) {
      return NextResponse.json(
        { error: 'Query is required' },
        { status: 400 }
      );
    }

    console.log('üñºÔ∏è Buscando imagem no Wikimedia Commons para:', query);

    // Traduzir query para ingl√™s se necess√°rio
    const englishQuery = await translateToEnglish(query, subject);
    console.log('üåç Query traduzida:', englishQuery);

    // Buscar no Wikimedia Commons
    const searchUrl = `https://commons.wikimedia.org/w/api.php?action=query&format=json&list=search&srsearch=${encodeURIComponent(englishQuery)}&srnamespace=6&srlimit=${count}&srprop=size&origin=*`;
    
    const response = await fetch(searchUrl);
    if (!response.ok) {
      throw new Error(`Wikimedia API error: ${response.status}`);
    }

    const data = await response.json();
    
    if (!data.query || !data.query.search || data.query.search.length === 0) {
      console.log('‚ö†Ô∏è Nenhuma imagem encontrada no Wikimedia Commons');
      return NextResponse.json({
        success: false,
        photos: [],
        query: englishQuery,
        source: 'wikimedia',
        fallback: true
      });
    }

    // Buscar informa√ß√µes detalhadas das imagens encontradas
    const imageTitles = data.query.search.map(item => item.title);
    const imageInfoUrl = `https://commons.wikimedia.org/w/api.php?action=query&format=json&titles=${imageTitles.join('|')}&prop=imageinfo&iiprop=url|size|mime&origin=*`;
    
    const imageInfoResponse = await fetch(imageInfoUrl);
    if (!imageInfoResponse.ok) {
      throw new Error(`Wikimedia image info API error: ${imageInfoResponse.status}`);
    }

    const imageInfoData = await imageInfoResponse.json();
    
    const photos = [];
    const pages = imageInfoData.query.pages;
    
    for (const pageId in pages) {
      const page = pages[pageId];
      if (page.imageinfo && page.imageinfo.length > 0) {
        const imageInfo = page.imageinfo[0];
        photos.push({
          id: pageId,
          title: page.title,
          url: imageInfo.url,
          width: imageInfo.width,
          height: imageInfo.height,
          mime: imageInfo.mime,
          source: 'wikimedia',
          description: page.title.replace('File:', ''),
          urls: {
            regular: imageInfo.url,
            small: imageInfo.url
          }
        });
      }
    }

    console.log(`‚úÖ ${photos.length} imagens encontradas no Wikimedia Commons`);

    return NextResponse.json({
      success: true,
      photos: photos.slice(0, count),
      query: englishQuery,
      source: 'wikimedia',
      fallback: false
    });

  } catch (error: any) {
    console.error('‚ùå Erro na busca do Wikimedia Commons:', error);
    return NextResponse.json({
      success: false,
      photos: [],
      error: error.message,
      source: 'wikimedia',
      fallback: true
    });
  }
}

// Fun√ß√£o para traduzir query para ingl√™s
async function translateToEnglish(query: string, subject?: string): Promise<string> {
  try {
    // Se j√° estiver em ingl√™s, retornar como est√°
    if (/^[a-zA-Z\s]+$/.test(query)) {
      return query;
    }

    // Usar API de tradu√ß√£o simples (pode ser melhorada)
    const translationResponse = await fetch('https://api.mymemory.translated.net/get', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    // Fallback: tradu√ß√£o manual b√°sica
    const translations: Record<string, string> = {
      'fotoss√≠ntese': 'photosynthesis',
      'cloroplastos': 'chloroplasts',
      'clorofila': 'chlorophyll',
      'glicose': 'glucose',
      'oxig√™nio': 'oxygen',
      'di√≥xido de carbono': 'carbon dioxide',
      '√°gua': 'water',
      'luz solar': 'sunlight',
      'energia': 'energy',
      'plantas': 'plants',
      'folhas': 'leaves',
      'c√©lulas': 'cells',
      'mitoc√¥ndrias': 'mitochondria',
      'respira√ß√£o': 'respiration',
      'metabolismo': 'metabolism',
      'enzimas': 'enzymes',
      'prote√≠nas': 'proteins',
      'DNA': 'DNA',
      'RNA': 'RNA',
      'cromossomos': 'chromosomes',
      'n√∫cleo': 'nucleus',
      'citoplasma': 'cytoplasm',
      'membrana': 'membrane',
      'organelas': 'organelles',
      'ribossomos': 'ribosomes',
      'ret√≠culo endoplasm√°tico': 'endoplasmic reticulum',
      'aparelho de golgi': 'golgi apparatus',
      'lisossomos': 'lysosomes',
      'vac√∫olos': 'vacuoles',
      'parede celular': 'cell wall',
      'flagelos': 'flagella',
      'c√≠lios': 'cilia',
      'microsc√≥pio': 'microscope',
      'laborat√≥rio': 'laboratory',
      'experimento': 'experiment',
      'pesquisa': 'research',
      'ci√™ncia': 'science',
      'biologia': 'biology',
      'qu√≠mica': 'chemistry',
      'f√≠sica': 'physics',
      'matem√°tica': 'mathematics',
      'hist√≥ria': 'history',
      'geografia': 'geography',
      'literatura': 'literature',
      'arte': 'art',
      'm√∫sica': 'music',
      'educa√ß√£o': 'education',
      'escola': 'school',
      'universidade': 'university',
      'professor': 'teacher',
      'estudante': 'student',
      'aula': 'lesson',
      'curso': 'course',
      'aprendizado': 'learning',
      'conhecimento': 'knowledge',
      'habilidades': 'skills',
      'compet√™ncias': 'competencies',
      'avalia√ß√£o': 'assessment',
      'prova': 'exam',
      'teste': 'test',
      'quiz': 'quiz',
      'exerc√≠cio': 'exercise',
      'atividade': 'activity',
      'projeto': 'project',
      'trabalho': 'work',
      'estudo': 'study',
      'pesquisa': 'research',
      'investiga√ß√£o': 'investigation',
      'descoberta': 'discovery',
      'inova√ß√£o': 'innovation',
      'tecnologia': 'technology',
      'computador': 'computer',
      'internet': 'internet',
      'software': 'software',
      'programa√ß√£o': 'programming',
      'algoritmo': 'algorithm',
      'dados': 'data',
      'informa√ß√£o': 'information',
      'comunica√ß√£o': 'communication',
      'colabora√ß√£o': 'collaboration',
      'trabalho em equipe': 'teamwork',
      'lideran√ßa': 'leadership',
      'criatividade': 'creativity',
      'imagina√ß√£o': 'imagination',
      'inspira√ß√£o': 'inspiration',
      'motiva√ß√£o': 'motivation',
      'dedica√ß√£o': 'dedication',
      'persist√™ncia': 'persistence',
      'determina√ß√£o': 'determination',
      'sucesso': 'success',
      'realiza√ß√£o': 'achievement',
      'conquista': 'conquest',
      'vit√≥ria': 'victory',
      'triumfo': 'triumph',
      'celebra√ß√£o': 'celebration',
      'felicidade': 'happiness',
      'alegria': 'joy',
      'satisfa√ß√£o': 'satisfaction',
      'orgulho': 'pride',
      'confian√ßa': 'confidence',
      'autoestima': 'self-esteem',
      'respeito': 'respect',
      'dignidade': 'dignity',
      'honra': 'honor',
      'integridade': 'integrity',
      'honestidade': 'honesty',
      'transpar√™ncia': 'transparency',
      '√©tica': 'ethics',
      'moral': 'morality',
      'valores': 'values',
      'princ√≠pios': 'principles',
      'virtudes': 'virtues',
      'qualidades': 'qualities',
      'caracter√≠sticas': 'characteristics',
      'atributos': 'attributes',
      'propriedades': 'properties',
      'caracter√≠sticas': 'features',
      'aspectos': 'aspects',
      'elementos': 'elements',
      'componentes': 'components',
      'partes': 'parts',
      'se√ß√µes': 'sections',
      'divis√µes': 'divisions',
      'categorias': 'categories',
      'tipos': 'types',
      'classes': 'classes',
      'grupos': 'groups',
      'fam√≠lias': 'families',
      'esp√©cies': 'species',
      'g√™neros': 'genera',
      'ordens': 'orders',
      'classes': 'classes',
      'filos': 'phyla',
      'reinos': 'kingdoms',
      'dom√≠nios': 'domains',
      'taxonomia': 'taxonomy',
      'classifica√ß√£o': 'classification',
      'sistema': 'system',
      'organiza√ß√£o': 'organization',
      'estrutura': 'structure',
      'arquitetura': 'architecture',
      'design': 'design',
      'plano': 'plan',
      'estrat√©gia': 'strategy',
      'm√©todo': 'method',
      't√©cnica': 'technique',
      'processo': 'process',
      'procedimento': 'procedure',
      'protocolo': 'protocol',
      'padr√£o': 'pattern',
      'modelo': 'model',
      'exemplo': 'example',
      'caso': 'case',
      'situa√ß√£o': 'situation',
      'contexto': 'context',
      'ambiente': 'environment',
      'ecossistema': 'ecosystem',
      'habitat': 'habitat',
      'biodiversidade': 'biodiversity',
      'sustentabilidade': 'sustainability',
      'conserva√ß√£o': 'conservation',
      'preserva√ß√£o': 'preservation',
      'prote√ß√£o': 'protection',
      'seguran√ßa': 'security',
      'prote√ß√£o': 'protection',
      'defesa': 'defense',
      'seguran√ßa': 'safety',
      'preven√ß√£o': 'prevention',
      'cuidado': 'care',
      'aten√ß√£o': 'attention',
      'foco': 'focus',
      'concentra√ß√£o': 'concentration',
      'dedica√ß√£o': 'dedication',
      'compromisso': 'commitment',
      'responsabilidade': 'responsibility',
      'obriga√ß√£o': 'obligation',
      'dever': 'duty',
      'miss√£o': 'mission',
      'prop√≥sito': 'purpose',
      'objetivo': 'objective',
      'meta': 'goal',
      'alvo': 'target',
      'destino': 'destination',
      'dire√ß√£o': 'direction',
      'caminho': 'path',
      'rota': 'route',
      'jornada': 'journey',
      'viagem': 'trip',
      'aventura': 'adventure',
      'experi√™ncia': 'experience',
      'viv√™ncia': 'living',
      'realidade': 'reality',
      'verdade': 'truth',
      'fato': 'fact',
      'evid√™ncia': 'evidence',
      'prova': 'proof',
      'demonstra√ß√£o': 'demonstration',
      'explica√ß√£o': 'explanation',
      'justificativa': 'justification',
      'argumento': 'argument',
      'raz√£o': 'reason',
      'causa': 'cause',
      'efeito': 'effect',
      'consequ√™ncia': 'consequence',
      'resultado': 'result',
      'outcome': 'outcome',
      'produto': 'product',
      'produ√ß√£o': 'production',
      'cria√ß√£o': 'creation',
      'inven√ß√£o': 'invention',
      'descoberta': 'discovery',
      'inova√ß√£o': 'innovation',
      'desenvolvimento': 'development',
      'evolu√ß√£o': 'evolution',
      'progresso': 'progress',
      'avan√ßo': 'advance',
      'melhoria': 'improvement',
      'otimiza√ß√£o': 'optimization',
      'efici√™ncia': 'efficiency',
      'efetividade': 'effectiveness',
      'qualidade': 'quality',
      'excel√™ncia': 'excellence',
      'perfei√ß√£o': 'perfection',
      'ideal': 'ideal',
      'padr√£o': 'standard',
      'crit√©rio': 'criterion',
      'medida': 'measure',
      'm√©trica': 'metric',
      'indicador': 'indicator',
      'par√¢metro': 'parameter',
      'vari√°vel': 'variable',
      'fator': 'factor',
      'elemento': 'element',
      'componente': 'component',
      'ingrediente': 'ingredient',
      'material': 'material',
      'subst√¢ncia': 'substance',
      'composto': 'compound',
      'mol√©cula': 'molecule',
      '√°tomo': 'atom',
      'part√≠cula': 'particle',
      'energia': 'energy',
      'for√ßa': 'force',
      'pot√™ncia': 'power',
      'intensidade': 'intensity',
      'magnitude': 'magnitude',
      'tamanho': 'size',
      'dimens√£o': 'dimension',
      'escala': 'scale',
      'propor√ß√£o': 'proportion',
      'raz√£o': 'ratio',
      'percentual': 'percentage',
      'fra√ß√£o': 'fraction',
      'decimal': 'decimal',
      'n√∫mero': 'number',
      'valor': 'value',
      'quantidade': 'quantity',
      'medida': 'measure',
      'unidade': 'unit',
      'metro': 'meter',
      'quil√¥metro': 'kilometer',
      'cent√≠metro': 'centimeter',
      'mil√≠metro': 'millimeter',
      'micr√¥metro': 'micrometer',
      'nan√¥metro': 'nanometer',
      'pic√¥metro': 'picometer',
      'femt√¥metro': 'femtometer',
      'att√¥metro': 'attometer',
      'zept√¥metro': 'zeptometer',
      'yoct√¥metro': 'yoctometer',
      'grama': 'gram',
      'quilograma': 'kilogram',
      'tonelada': 'ton',
      'libra': 'pound',
      'on√ßa': 'ounce',
      'segundo': 'second',
      'minuto': 'minute',
      'hora': 'hour',
      'dia': 'day',
      'semana': 'week',
      'm√™s': 'month',
      'ano': 'year',
      'd√©cada': 'decade',
      's√©culo': 'century',
      'mil√™nio': 'millennium',
      'era': 'era',
      '√©poca': 'epoch',
      'per√≠odo': 'period',
      'fase': 'phase',
      'etapa': 'stage',
      'est√°gio': 'stage',
      'n√≠vel': 'level',
      'grau': 'degree',
      'categoria': 'category',
      'classe': 'class',
      'tipo': 'type',
      'esp√©cie': 'species',
      'g√™nero': 'genus',
      'fam√≠lia': 'family',
      'ordem': 'order',
      'classe': 'class',
      'filo': 'phylum',
      'reino': 'kingdom',
      'dom√≠nio': 'domain',
      'taxonomia': 'taxonomy',
      'classifica√ß√£o': 'classification',
      'sistema': 'system',
      'organiza√ß√£o': 'organization',
      'estrutura': 'structure',
      'arquitetura': 'architecture',
      'design': 'design',
      'plano': 'plan',
      'estrat√©gia': 'strategy',
      'm√©todo': 'method',
      't√©cnica': 'technique',
      'processo': 'process',
      'procedimento': 'procedure',
      'protocolo': 'protocol',
      'padr√£o': 'pattern',
      'modelo': 'model',
      'exemplo': 'example',
      'caso': 'case',
      'situa√ß√£o': 'situation',
      'contexto': 'context',
      'ambiente': 'environment',
      'ecossistema': 'ecosystem',
      'habitat': 'habitat',
      'biodiversidade': 'biodiversity',
      'sustentabilidade': 'sustainability',
      'conserva√ß√£o': 'conservation',
      'preserva√ß√£o': 'preservation',
      'prote√ß√£o': 'protection',
      'seguran√ßa': 'security',
      'prote√ß√£o': 'protection',
      'defesa': 'defense',
      'seguran√ßa': 'safety',
      'preven√ß√£o': 'prevention',
      'cuidado': 'care',
      'aten√ß√£o': 'attention',
      'foco': 'focus',
      'concentra√ß√£o': 'concentration',
      'dedica√ß√£o': 'dedication',
      'compromisso': 'commitment',
      'responsabilidade': 'responsibility',
      'obriga√ß√£o': 'obligation',
      'dever': 'duty',
      'miss√£o': 'mission',
      'prop√≥sito': 'purpose',
      'objetivo': 'objective',
      'meta': 'goal',
      'alvo': 'target',
      'destino': 'destination',
      'dire√ß√£o': 'direction',
      'caminho': 'path',
      'rota': 'route',
      'jornada': 'journey',
      'viagem': 'trip',
      'aventura': 'adventure',
      'experi√™ncia': 'experience',
      'viv√™ncia': 'living',
      'realidade': 'reality',
      'verdade': 'truth',
      'fato': 'fact',
      'evid√™ncia': 'evidence',
      'prova': 'proof',
      'demonstra√ß√£o': 'demonstration',
      'explica√ß√£o': 'explanation',
      'justificativa': 'justification',
      'argumento': 'argument',
      'raz√£o': 'reason',
      'causa': 'cause',
      'efeito': 'effect',
      'consequ√™ncia': 'consequence',
      'resultado': 'result',
      'outcome': 'outcome',
      'produto': 'product',
      'produ√ß√£o': 'production',
      'cria√ß√£o': 'creation',
      'inven√ß√£o': 'invention',
      'descoberta': 'discovery',
      'inova√ß√£o': 'innovation',
      'desenvolvimento': 'development',
      'evolu√ß√£o': 'evolution',
      'progresso': 'progress',
      'avan√ßo': 'advance',
      'melhoria': 'improvement',
      'otimiza√ß√£o': 'optimization',
      'efici√™ncia': 'efficiency',
      'efetividade': 'effectiveness',
      'qualidade': 'quality',
      'excel√™ncia': 'excellence',
      'perfei√ß√£o': 'perfection',
      'ideal': 'ideal',
      'padr√£o': 'standard',
      'crit√©rio': 'criterion',
      'medida': 'measure',
      'm√©trica': 'metric',
      'indicador': 'indicator',
      'par√¢metro': 'parameter',
      'vari√°vel': 'variable',
      'fator': 'factor',
      'elemento': 'element',
      'componente': 'component',
      'ingrediente': 'ingredient',
      'material': 'material',
      'subst√¢ncia': 'substance',
      'composto': 'compound',
      'mol√©cula': 'molecule',
      '√°tomo': 'atom',
      'part√≠cula': 'particle',
      'energia': 'energy',
      'for√ßa': 'force',
      'pot√™ncia': 'power',
      'intensidade': 'intensity',
      'magnitude': 'magnitude',
      'tamanho': 'size',
      'dimens√£o': 'dimension',
      'escala': 'scale',
      'propor√ß√£o': 'proportion',
      'raz√£o': 'ratio',
      'percentual': 'percentage',
      'fra√ß√£o': 'fraction',
      'decimal': 'decimal',
      'n√∫mero': 'number',
      'valor': 'value',
      'quantidade': 'quantity',
      'medida': 'measure',
      'unidade': 'unit'
    };

    // Tentar tradu√ß√£o palavra por palavra
    const words = query.toLowerCase().split(' ');
    const translatedWords = words.map(word => {
      // Remover pontua√ß√£o
      const cleanWord = word.replace(/[.,!?;:]/g, '');
      return translations[cleanWord] || cleanWord;
    });

    return translatedWords.join(' ');
  } catch (error) {
    console.warn('‚ö†Ô∏è Erro na tradu√ß√£o, usando query original:', error);
    return query;
  }
}
